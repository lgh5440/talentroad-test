<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>달란트로드 — 은사·성향 검사 (표준 60)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
<style>
  .choice input:checked + label { border-color:#6d28d9; box-shadow:0 0 0 3px rgba(109,40,217,.15); background:#faf5ff; }
  .btn-disabled { opacity:.5; pointer-events:none; }
</style>
</head>
<body class="bg-gradient-to-br from-sky-100 to-emerald-100 min-h-screen text-slate-800">

<header class="max-w-5xl mx-auto px-4 py-6 flex items-center justify-between">
  <div class="flex items-center gap-3">
    <img src="/icons/dove.png" alt="달란트로드" class="h-8 w-8" onerror="this.style.display='none'"/>
    <h1 class="text-xl font-bold">달란트로드</h1>
  </div>
</header>

<main class="max-w-4xl mx-auto px-4 pb-20">

  <!-- 시작 화면 -->
  <section id="screen-start" class="bg-white/70 backdrop-blur rounded-2xl shadow p-6 sm:p-10">
    <div class="space-y-6">
      <h2 class="text-2xl sm:text-3xl font-extrabold tracking-tight">하나님이 주신 달란트, 지금 바로 길을 찾아보세요.</h2>
      <p class="text-slate-600">표준 60문항 · 약 10–12분 · 결과는 참고용입니다. 말씀과 기도로 분별하세요.</p>

      <div class="grid sm:grid-cols-4 gap-4">
        <label class="block text-sm font-medium">이름(선택)
          <input id="inp-name" class="mt-1 w-full rounded-lg border-slate-300 focus:border-violet-600 focus:ring-violet-600" placeholder="홍길동"/>
        </label>

        <label class="block text-sm font-medium">성별 <span class="text-rose-600">(필수)</span>
          <select id="inp-gender" class="mt-1 w-full rounded-lg border-slate-300 focus:border-violet-600 focus:ring-violet-600" required>
            <option value="" selected disabled>선택하세요</option>
            <option>남성</option>
            <option>여성</option>
            <option>기타</option>
          </select>
        </label>

        <label class="block text-sm font-medium">연령대 <span class="text-rose-600">(필수)</span>
          <select id="inp-age" class="mt-1 w-full rounded-lg border-slate-300 focus:border-violet-600 focus:ring-violet-600" required>
            <option value="" selected disabled>선택하세요</option>
            <option value="청소년">I. 청소년</option>
            <option value="청년">II. 청년</option>
            <option value="장년">III. 장년</option>
            <option value="노년">IV. 노년</option>
          </select>
        </label>

        <label class="block text-sm font-medium">지역(선택)
          <select id="inp-region" class="mt-1 w-full rounded-lg border-slate-300 focus:border-violet-600 focus:ring-violet-600">
            <option value="" selected>선택하세요</option>
            <option>서울</option><option>부산</option><option>대구</option><option>인천</option>
            <option>광주</option><option>대전</option><option>울산</option><option>세종</option>
            <option>경기</option><option>강원</option><option>충북</option><option>충남</option>
            <option>전북</option><option>전남</option><option>경북</option><option>경남</option>
            <option>제주</option><option>해외</option><option>기타</option>
          </select>
        </label>
      </div>

      <div class="rounded-xl border border-slate-200 bg-white/60 p-4">
        <p class="text-sm text-slate-600 leading-6">
          본 검사는 은사·성향 탐색을 위한 <b>참고용</b>입니다. 결과는 신학적 판단과 목회적 상담을 대체하지 않습니다.
          연구·서비스 개선을 위해 <b>익명 통계</b>로 활용될 수 있으며, 개인 식별 정보는 수집하지 않습니다.
        </p>
        <label class="mt-3 inline-flex items-center gap-2 text-sm">
          <input id="consent" type="checkbox" class="h-4 w-4">
          <span>위 내용을 이해하고 동의합니다.</span>
        </label>
      </div>

      <div class="flex flex-wrap gap-3">
        <button id="btn-start" type="button" class="px-5 py-3 rounded-xl bg-violet-700 text-white font-semibold hover:bg-violet-800 btn-disabled">검사 시작하기</button>
        <button id="btn-clear" type="button" class="px-5 py-3 rounded-xl border border-rose-300 text-rose-700 hover:bg-rose-50">초기화</button>
      </div>
    </div>
  </section>

  <!-- 진행 화면 -->
  <section id="screen-quiz" class="hidden mt-8 bg-white/80 backdrop-blur rounded-2xl shadow p-6 sm:p-10">
    <div class="mb-6">
      <div class="flex items-center justify-between text-sm text-slate-600 mb-1">
        <span id="progress-text">0 / 60 (0%)</span>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-3">
        <div id="progress-bar" class="h-3 rounded-full bg-violet-600 transition-all" style="width:0%"></div>
      </div>
    </div>

    <div>
      <h3 id="q-title" class="text-xl font-bold mb-4">문항 제목</h3>
      <div id="choices" class="space-y-3"></div>
    </div>

    <div class="mt-6 flex items-center justify-between">
      <button id="btn-prev" type="button" class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-white/60">이전</button>
      <button id="btn-next" type="button" class="px-5 py-2.5 rounded-lg bg-violet-700 text-white font-semibold hover:bg-violet-800">다음</button>
    </div>
  </section>

  <!-- 결과 화면 -->
  <section id="screen-result" class="hidden mt-8">
    <div id="result-card" class="bg-white/80 backdrop-blur rounded-2xl shadow p-6 sm:p-10">
      <div class="flex items-start gap-4 flex-wrap">
        <div class="grow">
          <h3 class="text-2xl sm:text-3xl font-extrabold mb-2">결과 요약</h3>
          <p id="result-sub" class="text-slate-700"></p>
        </div>
        <button id="btn-download" type="button" class="px-4 py-2 rounded-lg border border-slate-300 hover:bg-white">PDF 저장</button>
      </div>

      <div class="mt-6" id="top3"></div>

      <div class="mt-8">
        <h4 class="text-lg font-semibold mb-2">세부 점수</h4>
        <div id="score-table" class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm"></div>
      </div>

      <p class="mt-6 text-xs text-slate-500">
        ※ 본 결과는 참고용입니다. 말씀과 기도로 분별하시길 권장합니다.
      </p>

      <div class="mt-6 flex gap-3">
        <button id="btn-retry" type="button" class="px-5 py-3 rounded-xl border border-slate-300 text-slate-700 hover:bg-white/60">다시 검사</button>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== 헬퍼 ===== */
const $ = (s)=>document.querySelector(s);

/* ===== 설정 ===== */
const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyrGKEKSkNMuYkQnHEBniQQSUjpWWe00Q_LYjYfpcaNJw4zJDDHewp4zHv6p_B-KWI/exec';

/* ===== 유형 정의 ===== */
const TYPES = [
  { key:'L',  name:'리더십/조직' },
  { key:'C',  name:'돌봄/상담/자비' },
  { key:'S',  name:'섬김/봉사' },
  { key:'W',  name:'예배/예술' },
  { key:'T',  name:'지식/가르침/연구' },
  { key:'M',  name:'전도/선교/국제' },
  { key:'P',  name:'격려/중보기도' },
  { key:'R',  name:'창의/개척/도전' }
];

/* ===== 문항/척도 ===== */
const SCALE_LABELS = ['전혀 아니다','아니다','보통이다','그렇다','매우 그렇다'];
const QUESTIONS = [
  "새로운 모임에서 자연스럽게 분위기를 이끄는 편이다.",
  "다른 사람의 고민을 듣고 공감하는 것이 익숙하다.",
  "문제를 보면 해결 방법을 먼저 생각한다.",
  "힘든 일을 맡아도 기쁘게 감당하는 편이다.",
  "음악이나 예술로 내 마음을 표현하는 것을 즐긴다.",
  "다른 사람을 위해 기도하는 시간을 소중히 여긴다.",
  "준비 과정이나 뒷정리 봉사를 의미 있게 여긴다.",
  "사람들을 조직하고 계획을 세우는 역할이 잘 맞는다.",
  "소그룹이나 목장을 돌보는 일을 즐긴다.",
  "행정, 재정, 시설 관리 같은 실무를 잘 감당할 수 있다.",
  "나의 재능(요리, 디자인, 글쓰기 등)을 섬김에 활용하고 싶다.",
  "새로운 사역이나 프로젝트를 시작하는 것이 즐겁다.",
  "다른 사람의 이야기를 경청하는 것이 편하다.",
  "환경 정리, 배식, 돌봄 같은 봉사를 잘 감당한다.",
  "사회적 약자를 돕는 일에 마음이 끌린다.",
  "반복적인 일보다 변화와 도전을 선호한다.",
  "협력하는 일이 혼자 하는 일보다 즐겁다.",
  "다른 사람의 감정을 민감하게 파악한다.",
  "분석과 정리를 통해 문제를 해결한다.",
  "새로운 지식이나 기술을 배우는 것을 즐긴다.",
  "전도나 선교에 적극적으로 관심이 있다.",
  "찬양이나 율동으로 다른 사람을 이끄는 것을 즐긴다.",
  "기도의 응답이나 하나님의 임재를 경험한 적이 있다.",
  "재정적으로 나누고 후원하는 것에 기쁨을 느낀다.",
  "갈등 상황에서 화해를 이끌어내는 편이다.",
  "가르치거나 멘토링하는 일을 좋아한다.",
  "새로운 아이디어를 제안하고 실행한다.",
  "아픈 자나 약자를 돌보는 데 마음이 끌린다.",
  "영적 진리를 탐구하고 연구하는 것을 즐긴다.",
  "어려운 상황에서도 공동체를 격려하고 세운다.",
  "사람을 만나 대화할 때 에너지가 난다.",
  "결과보다 과정에서 배우는 것을 중시한다.",
  "일을 맡으면 끝까지 책임지는 편이다.",
  "새로운 환경에 적응하는 데 자신 있다.",
  "내 생각이나 아이디어로 다른 사람에게 영향을 주곤 한다.",
  "상황에 맞게 유연하게 행동하는 것이 편하다.",
  "규칙적이고 반복적인 생활을 좋아한다.",
  "변화와 도전을 즐기며 새로운 경험을 찾는다.",
  "협력하는 활동이 혼자 하는 것보다 좋다.",
  "혼자 집중해서 몰입하는 시간을 중시한다.",
  "창의적인 활동(그림, 음악, 글쓰기 등)이 즐겁다.",
  "논리적으로 분석하고 자료를 정리하는 능력이 있다.",
  "감정을 솔직하게 표현하는 편이다.",
  "조용히 묵상하고 내면을 돌아보는 시간을 중요하게 여긴다.",
  "운동이나 활동으로 스트레스를 푼다.",
  "직업을 선택할 때 돈보다 의미가 더 중요하다.",
  "내가 잘하는 것을 살려 다른 사람을 돕고 싶다.",
  "사회 문제(환경, 아동, 노인 등)에 관심이 많다.",
  "사람을 가르치거나 지도하는 일이 잘 맞는다.",
  "복지·돌봄 분야에서 일하는 것을 고려해본 적이 있다.",
  "예술이나 미디어로 표현하는 직업에 끌린다.",
  "경영이나 행정 관련 일에 관심이 있다.",
  "기술·과학·IT 분야에 흥미가 있다.",
  "새로운 아이디어를 현실화하는 창업에 관심이 있다.",
  "직업 선택 시 신앙과 가치관을 가장 먼저 고려한다.",
  "공동체와 함께 협력하는 직업이 더 잘 맞는다.",
  "혼자 몰입해서 연구하거나 제작하는 직업이 잘 맞는다.",
  "사람을 돌보고 상담하는 일을 직업으로 삼고 싶다.",
  "국제적 경험이나 선교적 성격의 직업에 관심이 있다.",
  "직업을 통해 하나님 나라를 확장하는 것이 가능하다고 믿는다."
];

/* ===== 문항→유형 매핑 ===== */
const MAP = {
  L:[1,8,32,35],
  C:[2,13,18,25,28,59],
  S:[4,7,14,33,39,47],
  W:[5,22,41],
  T:[19,20,26,29,42,49],
  M:[21,31,55,60],
  P:[6,23,30,44],
  R:[3,11,12,16,27,34,36,38,40,43,50,53,54,56,57,58]
};

/* ===== 52개 조합 설명 ===== */
const COMBO = {
  "C+L+S":{title:"실천적 돌봄 리더",desc:"조직력(L)을 발휘하여 사람들을 돌보고(C), 실무적인 섬김(S)으로 공동체의 필요를 채웁니다."},
  "C+L+W":{title:"영성 문화 코디네이터",desc:"리더십(L)으로 예배(W)와 영성을 이끌고, 돌봄(C)으로 감성적 소통을 중시합니다."},
  "C+L+T":{title:"양육 멘토링 디렉터",desc:"가르침(T)과 돌봄(C)을 조직적(L)으로 결합해 영적 성장을 돕는 코치형 리더입니다."},
  "C+L+M":{title:"글로벌 선교 돌봄 리더",desc:"선교(M) 비전을 제시하고 조직력(L)으로 타문화권 돌봄(C) 사역을 추진합니다."},
  "C+L+P":{title:"영적 치유 공동체장",desc:"기도(P)와 돌봄(C)을 바탕으로 공동체의 영적 건강을 회복시키고 질서(L)를 세웁니다."},
  "C+L+R":{title:"창의적 사역 개발자",desc:"창의(R) 아이디어로 돌봄(C) 프로젝트를 개발하고 리더십(L)으로 추진합니다."},
  "L+S+W":{title:"예배 환경 총괄 리더",desc:"예배(W) 질서를 조직(L)하고 섬김(S)으로 예배 환경을 완성합니다."},
  "L+S+T":{title:"시스템 행정 교육 책임자",desc:"행정(S)·교육(T) 시스템을 조직(L)해 공동체 효율을 극대화합니다."},
  "L+M+S":{title:"해외 현장 지원 책임자",desc:"선교(M) 비전 아래 실무 섬김(S)을 조직(L)하여 현장 필요를 채웁니다."},
  "L+P+S":{title:"헌신적 실천 리더",desc:"섬김(S)과 기도(P)를 바탕으로 조직(L) 목표를 실천하는 모범 리더입니다."},
  "L+R+S":{title:"창의 혁신 프로젝트 리더",desc:"창의(R)로 실무(S) 문제를 해결하는 프로젝트를 조직(L)으로 성공시킵니다."},
  "L+T+W":{title:"예배자 양육 디렉터",desc:"예배(W) 원리를 가르치며(T), 예배자를 조직(L)으로 훈련합니다."},
  "L+M+W":{title:"문화 선교 협력 리더",desc:"예배/문화(W)를 선교(M) 관점에서 조직(L)하여 국제 협력을 추진합니다."},
  "L+P+W":{title:"영적 집회 인도자",desc:"기도/영성(P)으로 예배(W)를 주도하고 리더십(L)을 발휘합니다."},
  "L+R+T":{title:"비전 전략 교육 기획자",desc:"창의(R) 커리큘럼을 개발하고(T), 교육 전략을 조직(L)으로 이끕니다."},
  "L+M+P":{title:"선교 전략 중보 책임자",desc:"선교(M) 전략을 조직(L)하고 기도(P)로 후원합니다."},
  "L+M+R":{title:"글로벌 비전 개척자",desc:"창의(R) 접근으로 새로운 선교지(M)를 개척하고 조직(L)으로 추진합니다."},
  "L+P+R":{title:"혁신적 영성 리더",desc:"혁신(R)으로 공동체 영성(P)을 새롭게 이끌며 리더십(L)을 발휘합니다."},
  "C+S+W":{title:"공간 치유 봉사자",desc:"섬김(S)으로 아름다운 예배(W) 환경을 만들고, 방문자를 돌봄(C)으로 맞습니다."},
  "C+S+T":{title:"실무 멘토링 코치",desc:"실무 섬김(S)을 돕고 경험 기반 지식(T)으로 가르치며 돌봄(C)을 실천합니다."},
  "C+M+S":{title:"현장 구호 복지 전문가",desc:"선교(M) 현장에서 실질 섬김(S)으로 취약한 이들을 깊이 돌봄(C)합니다."},
  "C+P+S":{title:"따뜻한 심방 사역자",desc:"헌신 섬김(S)과 중보(P)로 일대일 돌봄(C)에 집중합니다."},
  "C+R+S":{title:"맞춤형 봉사 개발자",desc:"창의(R)로 돌봄(C)이 필요한 이들을 위한 맞춤 섬김(S) 프로그램을 만듭니다."},
  "C+T+W":{title:"예술 치유 교육자",desc:"예배/예술(W)로 정서적 치유(C)를 돕고, 원리(T)를 가르칩니다."},
  "C+M+W":{title:"다문화 정서 지원가",desc:"선교(M)에서 문화(W)를 이해하며 이주민/선교사 돌봄(C)을 지원합니다."},
  "C+P+W":{title:"위로의 중보자",desc:"깊은 기도(P)와 예배(W)의 감동으로 지친 영혼을 돌봄(C)합니다."},
  "C+M+T":{title:"국제 교육 멘토",desc:"선교적(M) 관점으로 타문화권에 교육(T)과 멘토링을 제공하며 돌봄(C)합니다."},
  "C+P+T":{title:"영적 성장 코치",desc:"진리(T)를 기반으로 성장을 돕고, 중보(P)로 돌봄(C)을 더합니다."},
  "C+R+T":{title:"돌봄 콘텐츠 기획자",desc:"창의(R)로 상담·돌봄(C) 교육자료/도구(T)를 개발합니다."},
  "C+M+P":{title:"선교지 기도 지원가",desc:"선교(M) 필요를 공감(C)하며 헌신적 중보(P)로 후방을 지원합니다."},
  "C+M+R":{title:"창의적 국제 개발자",desc:"창의(R) 프로젝트로 국제개발/선교(M)에 참여하고 돌봄(C)을 실천합니다."},
  "C+P+R":{title:"감성 회복 디자이너",desc:"창의(R)로 영적 돌봄(C) 시스템을 혁신하고 기도(P)로 회복을 돕습니다."},
  "S+T+W":{title:"예배 실무 기술 교육자",desc:"예배(W)에 필요한 실무(S)를 체계적으로 교육(T)합니다."},
  "M+S+W":{title:"해외 사역 환경 조성가",desc:"선교(M) 현장의 예배(W) 공간/시설을 섬김(S)으로 구축합니다."},
  "P+S+W":{title:"성전 환경 중보자",desc:"예배(W) 환경을 섬김(S)으로 조성하고 기도(P)로 정화합니다."},
  "R+S+W":{title:"미디어 공간 크리에이터",desc:"예배(W) 공간을 창의(R)로 디자인하고 실무(S)로 구현합니다."},
  "M+S+T":{title:"국제 행정 실무 전문가",desc:"선교(M) 관련 행정(S)을 체계적으로 처리하고 문서/언어 교육(T)을 지원합니다."},
  "P+S+T":{title:"체계적 사역 기록가",desc:"사역을 꼼꼼히 기록(S)해 교육자료(T)로 활용하며 기도(P)로 후원합니다."},
  "R+S+T":{title:"실용 시스템 기획자",desc:"창의(R)로 실무(S) 효율을 높이는 교육자료/시스템(T)을 개발합니다."},
  "M+P+S":{title:"물류 지원 중보자",desc:"선교사/현장 물류(S)를 지원하고 정기 중보(P)로 후방을 돕습니다."},
  "M+R+S":{title:"선교 장비 개발자",desc:"선교지(M) 맞춤 창의(R) 도구/장비를 제작(S)·공급합니다."},
  "P+R+S":{title:"환경 개선 발명가",desc:"창의(R)로 봉사(S) 환경을 개선하고 기도(P)로 힘을 더합니다."},
  "M+T+W":{title:"다문화 예술 강사",desc:"선교(M) 위해 문화감각(W)으로 현지인 교육(T)을 제공합니다."},
  "P+T+W":{title:"영성 예배 신학자",desc:"영성(P)을 바탕으로 예배(W)의 신학/교리(T)를 연구·가르칩니다."},
  "R+T+W":{title:"창의적 미디어 교육자",desc:"창의(R) 미디어로 예배(W) 콘텐츠를 제작하고 지식(T)을 교육합니다."},
  "M+P+W":{title:"국제 영적 문화 대변자",desc:"선교지(M) 영적 상황을 기도(P)로 대변하며 예배(W)로 소통합니다."},
  "M+R+W":{title:"문화 선교 콘텐츠 디자이너",desc:"창의(R)로 선교(M)용 예배/문화(W) 콘텐츠를 기획·제작합니다."},
  "P+R+W":{title:"영적 공간 아키텍트",desc:"창의(R)·예술로 기도/묵상(P)을 위한 영성 공간(W)을 디자인합니다."},
  "M+P+T":{title:"선교 연구 중보 전문가",desc:"선교(M) 전략/상황을 연구(T)하고 전략적 중보(P)를 인도합니다."},
  "M+R+T":{title:"글로벌 교육 공학자",desc:"창의(R) 기술로 선교지(M) 맞춤 교육자료(T)를 개발합니다."},
  "P+R+T":{title:"철학적 영성 탐구자",desc:"창의(R) 사고로 진리(T)를 탐구하고 기도(P)로 묵상·나눕니다."},
  "M+P+R":{title:"창의적 모금 기획자",desc:"창의(R) 방식으로 선교(M) 비전을 알리고 기도(P)로 후원을 조성합니다."},
  "L+P+T":{title:"체계적 멘토링 리더",desc:"가르침(T)과 리더십(L), 중보(P)가 결합되어 사람을 세우고 공동체 성장을 촉진합니다."}
};

/* ===== 상태 ===== */
let state = { i:0, answers:Array(QUESTIONS.length).fill(null), name:'', gender:'', age:'', region:'', rt:Array(QUESTIONS.length).fill(0) };
let qStart = 0;

/* ===== 시작 버튼 활성화 ===== */
function toggleStartBtn(){
  const ok = $('#consent').checked && !!$('#inp-gender').value && !!$('#inp-age').value;
  $('#btn-start').classList.toggle('btn-disabled', !ok);
}
document.addEventListener('DOMContentLoaded', ()=>{
  toggleStartBtn();
  $('#consent').addEventListener('change', toggleStartBtn);
  $('#inp-gender').addEventListener('change', toggleStartBtn);
  $('#inp-age').addEventListener('change', toggleStartBtn);

  $('#btn-start').addEventListener('click', ()=>{
    if(!$('#consent').checked) return alert('동의가 필요합니다.');
    if(!$('#inp-gender').value) return alert('성별을 선택해 주세요.');
    if(!$('#inp-age').value) return alert('연령대를 선택해 주세요.');

    state = {
      i:0,
      answers:Array(QUESTIONS.length).fill(null),
      name: ($('#inp-name').value||'').trim(),
      gender: $('#inp-gender').value,
      age: $('#inp-age').value,
      region: $('#inp-region').value || '',
      rt: Array(QUESTIONS.length).fill(0)
    };
    showQuiz();
  });

  $('#btn-clear').addEventListener('click', ()=>location.reload());
  $('#btn-prev').addEventListener('click', prev);
  $('#btn-next').addEventListener('click', next);
  $('#btn-retry').addEventListener('click', ()=>location.reload());
  $('#btn-download').addEventListener('click', ()=>{
    const target = $('#result-card');
    const opt = { margin:10, filename:`달란트로드_결과_${Date.now()}.pdf`, image:{type:'jpeg',quality:0.98}, html2pdf:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
    html2pdf().from(target).set(opt).save();
  });
});

/* ===== 화면 전환 ===== */
function showQuiz(){
  $('#screen-start').classList.add('hidden');
  $('#screen-quiz').classList.remove('hidden');
  $('#screen-result').classList.add('hidden');
  renderQuestion();
}
function showResult(){
  $('#screen-start').classList.add('hidden');
  $('#screen-quiz').classList.add('hidden');
  $('#screen-result').classList.remove('hidden');
  renderResult();
}

/* ===== 문항 렌더 ===== */
function renderQuestion(){
  const i = state.i, q = QUESTIONS[i];
  $('#q-title').textContent = `Q${i+1}. ${q}`;
  const wrap = $('#choices'); wrap.innerHTML = '';

  SCALE_LABELS.forEach((txt, idx)=>{
    const val = idx+1, id = `q${i}_v${val}`;
    const checked = state.answers[i]===val ? 'checked' : '';
    wrap.insertAdjacentHTML('beforeend', `
      <div class="choice">
        <input class="peer hidden" type="radio" id="${id}" name="q${i}" value="${val}" ${checked}/>
        <label for="${id}" class="block rounded-xl border border-slate-300 p-3 cursor-pointer peer-checked:border-violet-700">
          <span class="font-medium">${txt}</span>
        </label>
      </div>`);
  });

  const isLast = (i === QUESTIONS.length - 1);
  $('#btn-next').textContent = isLast ? '제출' : '다음';
  $('#btn-prev').disabled = (i===0);
  toggleNextBtn(!!state.answers[i]);

  document.querySelectorAll(`input[name="q${i}"]`).forEach(r=>{
    r.addEventListener('change', ()=>{
      state.answers[i] = Number(r.value);
      toggleNextBtn(true);
    });
  });

  const pct = Math.round((i)/QUESTIONS.length*100);
  $('#progress-text').textContent = `${i} / ${QUESTIONS.length} (${pct}%)`;
  $('#progress-bar').style.width = `${pct}%`;

  qStart = performance.now();
}
function toggleNextBtn(enabled){ $('#btn-next').classList.toggle('btn-disabled', !enabled); }

/* ===== 점수 계산 ===== */
function calcScores(){
  const sums = {L:0,C:0,S:0,W:0,T:0,M:0,P:0,R:0};
  const counts = {L:0,C:0,S:0,W:0,T:0,M:0,P:0,R:0};
  Object.keys(MAP).forEach(k=>{
    MAP[k].forEach(n=>{
      const a = state.answers[n-1];
      if(a!=null){ sums[k]+=a; counts[k]++; }
    });
  });
  return Object.keys(sums).map(k=>{
    const type = TYPES.find(t=>t.key===k);
    const avg = counts[k] ? sums[k]/counts[k] : 0;
    return { key:k, name:type.name, sum:sums[k], n:counts[k], avg, norm: Math.round((avg-1)/4*100) };
  }).sort((a,b)=>b.norm-a.norm);
}

/* ===== 조합키 정렬 & 이름 ===== */
function toComboKey(a,b,c){
  const order = ['C','L','M','P','R','S','T','W'];
  return [a,b,c].sort((x,y)=>order.indexOf(x)-order.indexOf(y)).join('+');
}
function typeNameByKey(k){ return (TYPES.find(t=>t.key===k)||{}).name || k; }

/* ===== 결과 렌더 ===== */
function renderResult(){
  const scores = calcScores();
  const top3 = scores.slice(0,3);
  const comboKey = toComboKey(top3[0].key, top3[1].key, top3[2].key);
  const combo = COMBO[comboKey] || {title:`${comboKey} 조합`, desc:'세 은사가 조화를 이루어 공동체에 독특한 기여를 기대할 수 있습니다.'};
  const areaText = [top3[0].key, top3[1].key, top3[2].key].map(k=>typeNameByKey(k)).join(' · ');

  $('#result-sub').innerHTML =
    `<div class="space-y-1">
       <div><span class="text-slate-500">조합</span>: <b class="text-violet-700">${comboKey}</b></div>
       <div><span class="text-slate-500">은사영역</span>: ${areaText}</div>
       <div><span class="text-slate-500">조합명칭</span>: <b>${combo.title}</b></div>
       <div><span class="text-slate-500">간단설명</span>: ${combo.desc}</div>
     </div>`;

  $('#top3').innerHTML = `
    <article class="rounded-2xl border border-slate-200 p-5 bg-white/80">
      <div class="text-sm text-slate-500 mb-1">조합: <b class="text-violet-700">${comboKey}</b></div>
      <h5 class="text-lg font-bold">${combo.title}</h5>
      <p class="mt-2 text-slate-700 leading-6">${combo.desc}</p>
      <p class="mt-3 text-xs text-slate-500">※ TOP1·2·3 점수는 아래 ‘세부 점수’에서 확인하세요.</p>
    </article>
  `;

  const tbl = $('#score-table'); tbl.innerHTML='';
  scores.forEach((s, idx)=>{
    const rank = idx + 1;
    const badge = rank <= 3
      ? `<span class="ml-2 shrink-0 inline-flex items-center justify-center text-xs px-2 py-0.5 rounded-full bg-violet-100 text-violet-700 font-semibold">TOP ${rank}</span>`
      : '';
    tbl.insertAdjacentHTML('beforeend',
      `<div class="px-3 py-2 rounded-lg bg-white/60 border border-slate-200 flex items-center justify-between min-w-0">
         <span class="flex items-center whitespace-nowrap min-w-0">
           <b class="shrink-0">${s.key}</b><span class="mx-1">·</span>
           <span class="truncate">${s.name}</span>${badge}
         </span>
         <span class="font-semibold shrink-0 ml-3">${s.norm}</span>
       </div>`);
  });
}

/* ===== 저장 ===== */
async function saveToSheets(payload){
  try{
    await fetch(WEB_APP_URL, {
      method:'POST',
      mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
  }catch(e){ console.error('시트 저장 실패:', e); }
}

/* ===== 네비게이션 ===== */
async function next(){
  const sel = document.querySelector(`input[name="q${state.i}"]:checked`);
  if(!sel){ alert('답변을 선택해야 다음으로 넘어갈 수 있습니다.'); return; }

  state.rt[state.i] = Math.round(performance.now() - qStart);
  state.answers[state.i] = Number(sel.value);

  if(state.i >= QUESTIONS.length-1){
    const scores = calcScores();
    const payload = {
      timestamp: new Date().toISOString(),
      instrumentVersion: 'std60_v8',
      user: { name: state.name, gender: state.gender, ageGroup: state.age, region: state.region },
      answers: state.answers,
      rt_ms: state.rt,
      scoresRaw: scores.reduce((o,s)=> (o[s.key]=s.sum, o), {}),
      scoresNorm: scores.reduce((o,s)=> (o[s.key]=s.norm, o), {}),
      top: scores.slice(0,3).map(s=>({type:s.key, name:s.name, norm:s.norm}))
    };
    await saveToSheets(payload);
    showResult();
  } else {
    state.i++; renderQuestion();
  }
}
function prev(){ if(state.i>0){ state.i--; renderQuestion(); } }
</script>
</body>
</html>
